---
import Layout from '../../../../layouts/Layout.astro';
import MetricsGrid from '../../../../components/v2/MetricsGrid.astro';
import KeywordsTable from '../../../../components/v2/KeywordsTable.astro';
import AuditCard from '../../../../components/v2/AuditCard.astro';
import AuditDetail from '../../../../components/v2/AuditDetail.astro';
import PositionChart from '../../../../components/v2/PositionChart.tsx';
import TrendChart from '../../../../components/v2/TrendChart.tsx';
import {
  getClient,
  getClientPages,
  getPageTimeline,
  getPageKeywords,
  getPagesSummary,
  getPageAuditCards,
  getAuditDetail,
} from '../../../../lib/db.js';

export function getStaticPaths() {
  // Use getClientPages to get ALL pages ever tracked (not filtered by recent activity)
  const pages = getClientPages('cs');

  return pages.map(p => {
    const path = new URL(p.page_url).pathname.replace(/^\/|\/$/g, '');
    const slug = path.replace(/\//g, '-') || 'homepage';
    return {
      params: { slug },
      props: { pageUrl: p.page_url },
    };
  });
}

const { slug } = Astro.params;
const { pageUrl } = Astro.props;

const client = getClient('cs');
const timeline = getPageTimeline('cs', pageUrl, 0); // All historical data — chart handles time range filtering
const keywords = getPageKeywords('cs', pageUrl);

// Page-level aggregate (last 28 days)
const recent = timeline.filter(d => {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - 28);
  return new Date(d.date) >= cutoff;
});

const totalClicks = recent.reduce((s, d) => s + d.clicks, 0);
const totalImpressions = recent.reduce((s, d) => s + d.impressions, 0);
const avgPosition = totalImpressions > 0
  ? Math.round(recent.reduce((s, d) => s + d.position * d.impressions, 0) / totalImpressions * 10) / 10
  : 0;
const ctr = totalImpressions > 0
  ? Math.round(totalClicks / totalImpressions * 10000) / 100
  : 0;

// Derive page name from URL
const urlPath = new URL(pageUrl).pathname;
const pageName = urlPath === '/' ? 'Homepage' :
  urlPath.replace(/^\/|\/$/g, '').split('/').pop()?.replace(/-/g, ' ')
    .replace(/\b\w/g, c => c.toUpperCase()) || urlPath;

const metrics = [
  { label: 'Clicks (28d)', value: totalClicks, color: 'text-blue-700' },
  { label: 'Impressions', value: totalImpressions.toLocaleString(), color: 'text-purple-700' },
  { label: 'CTR', value: ctr + '%' },
  { label: 'Avg Position', value: avgPosition },
  { label: 'Keywords', value: keywords.length },
];

// Position data for chart
const positionData = timeline.map(d => ({ date: d.date, position: d.position }));
const trendData = timeline.map(d => ({ date: d.date, clicks: d.clicks, impressions: d.impressions }));

// Audit data
const auditCards = getPageAuditCards('cs', pageUrl);
const totalPending = auditCards.reduce((s, c) => s + c.pending_count, 0);

// Group cards by tier
const tiers = [
  { tier: 1, label: 'Tier 1: Foundational' },
  { tier: 2, label: 'Tier 2: On-Page Signals' },
  { tier: 3, label: 'Tier 3: Technical Performance' },
  { tier: 4, label: 'Tier 4: Content Enrichment' },
  { tier: 5, label: 'Tier 5: Authority & Stability' },
  { tier: 6, label: 'Tier 6: Advanced' },
];

// Pre-load audit details for cards that have been audited
const auditDetails = {};
for (const card of auditCards) {
  if (card.audit_status === 'audited') {
    const detail = getAuditDetail('cs', pageUrl, card.dimension_id);
    auditDetails[card.dimension_id] = detail;
  }
}
---

<Layout title={`${pageName} - ${client.name}`}>
  <!-- Back to dashboard -->
  <div class="mb-4">
    <a href="/v2/cs/" class="text-sm text-blue-600 hover:text-blue-800">&larr; Back to Dashboard</a>
  </div>

  <!-- Page Header -->
  <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6">
    <h2 class="text-xl sm:text-2xl font-bold text-gray-900">{pageName}</h2>
    <p class="text-sm text-gray-500 mt-1 break-all">{pageUrl}</p>
    <p class="text-xs text-gray-400 mt-2">{client.name} · {client.domain}</p>
  </div>

  <!-- Metrics -->
  <div class="mb-6">
    <MetricsGrid metrics={metrics} />
  </div>

  <!-- Position Timeline -->
  {positionData.length > 0 && (
    <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6">
      <PositionChart client:load data={positionData} title="Position History" />
    </div>
  )}

  <!-- Traffic Timeline -->
  {trendData.length > 0 && (
    <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6">
      <TrendChart client:load data={trendData} title="Clicks & Impressions" />
    </div>
  )}

  <!-- Audit Cards -->
  {auditCards.length > 0 && (
    <div class="mb-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-bold text-gray-900">Page Audit</h3>
        {totalPending > 0 && (
          <span class="admin-only hidden inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-amber-100 text-amber-800">
            {totalPending} pending item{totalPending !== 1 ? 's' : ''}
          </span>
        )}
      </div>

      {tiers.map(({ tier, label }) => {
        const tierCards = auditCards.filter(c => c.tier === tier);
        if (tierCards.length === 0) return null;
        const isPlaceholderTier = tierCards.every(c => c.category === 'placeholder');
        return (
          <div class="mb-6">
            <div class="flex items-center gap-2 mb-3">
              <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">{label}</h4>
              {isPlaceholderTier && (
                <span class="text-xs text-purple-500">&#x2B21;</span>
              )}
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
              {tierCards.map(card => (
                <div>
                  <AuditCard
                    dimensionId={card.dimension_id}
                    name={card.name}
                    tier={card.tier}
                    category={card.category}
                    auditStatus={card.audit_status}
                    summary={card.summary}
                    score={card.score}
                    pendingCount={card.pending_count}
                    completedCount={card.completed_count}
                    totalItems={card.total_items}
                    cardDescription={card.card_description}
                  />
                  {auditDetails[card.dimension_id] && (
                    <AuditDetail
                      dimensionId={card.dimension_id}
                      name={card.name}
                      findings={auditDetails[card.dimension_id].run?.findings || null}
                      score={card.score}
                      runDate={auditDetails[card.dimension_id].run?.run_date || null}
                      items={auditDetails[card.dimension_id].items || []}
                    />
                  )}
                </div>
              ))}
            </div>
          </div>
        );
      })}
    </div>
  )}

  <!-- Keywords Table -->
  {keywords.length > 0 && (
    <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 mb-6">
      <h3 class="text-lg font-bold text-gray-900 mb-3">Keywords ({keywords.length})</h3>
      <KeywordsTable
        keywords={keywords}
        expandable={keywords.length > 20}
        initialShow={20}
        tableId="page-kw"
      />
    </div>
  )}

  <!-- Footer -->
  <div class="text-center text-xs text-gray-400 mt-8 mb-4">
    <p>Data: Google Search Console · Updated daily</p>
  </div>
</Layout>
