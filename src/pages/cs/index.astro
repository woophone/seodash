---
import Layout from '../../layouts/Layout.astro';
import { clientData } from '../../data/compulsionsolutions-data.js';

const { client, overview, pages } = clientData;

// Pre-process pages for template use (Astro JSX can't use < > in expressions)
const page1Count = pages.filter(p => p.position <= 10.4).length;
const page2Count = pages.filter(p => p.position > 10.4 && p.position <= 20).length;

function posColor(pos) {
  if (pos <= 10.4) return 'bg-green-100 text-green-800';
  if (pos <= 20) return 'bg-orange-100 text-orange-800';
  return 'bg-gray-100 text-gray-600';
}

function posTextColor(pos) {
  if (pos <= 10) return 'text-green-700';
  if (pos <= 20) return 'text-orange-600';
  return 'text-gray-500';
}

const processedPages = pages.map((page, i) => ({
  ...page,
  index: i,
  posColor: posColor(page.position),
  clickQueries: page.queries.filter(q => q.clicks >= 1),
  impressionOnlyQueries: page.queries.filter(q => q.clicks === 0 && q.impressions >= 5),
}));

const totalKeywords = pages.reduce((sum, p) => sum + p.queries.length, 0);
---

<Layout title={`${client.name} - SEO Dashboard`}>
  <!-- Client Header -->
  <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-3xl font-bold text-gray-900">{client.name}</h2>
        <p class="text-lg text-gray-600 mt-1">{client.domain}</p>
        <p class="text-sm text-gray-500 mt-2">{client.industry}</p>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-400">{client.dataSource}</p>
        <p class="text-xs text-gray-400 mt-1">Analysis: {client.analysisDate}</p>
      </div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Clicks (28d)</p>
      <p class="text-2xl font-bold text-gray-900">{overview.totalClicks.toLocaleString()}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Impressions</p>
      <p class="text-2xl font-bold text-gray-900">{overview.totalImpressions.toLocaleString()}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">CTR</p>
      <p class="text-2xl font-bold text-gray-900">{overview.ctr}%</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Avg Position</p>
      <p class="text-2xl font-bold text-gray-900">{overview.avgPosition}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Tracked Pages</p>
      <p class="text-2xl font-bold text-gray-900">{overview.trackedPages}</p>
    </div>
  </div>

  <!-- Crash Note -->
  {overview.crashNote && (
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-amber-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-sm text-amber-800">{overview.crashNote}</p>
      </div>
    </div>
  )}

  <!-- Pages + Keywords Browser -->
  <div class="bg-white rounded-lg shadow-sm overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Pages & Keywords</h3>
        <p class="text-xs text-gray-400">{page1Count} on page 1 &middot; {page2Count} on page 2 &middot; sorted by clicks</p>
      </div>
    </div>

    <div class="divide-y divide-gray-100">
      {processedPages.map(page => (
          <div class="page-row">
            {/* Page header row — always visible */}
            <button
              data-toggle={`page-${page.index}`}
              class="w-full text-left px-6 py-4 hover:bg-gray-50 transition-colors"
            >
              <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1 min-w-0">
                  <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-bold flex-shrink-0 ${page.posColor}`}>
                    #{page.position.toFixed(1)}
                  </span>
                  <div class="min-w-0">
                    <div class="flex items-center gap-2">
                      <p class="text-sm font-medium text-gray-900 truncate">{page.shortName}</p>
                      {page.reportSlug && (
                        <a href={`/cs/pages/${page.reportSlug}/`} class="inline-flex items-center text-green-600 hover:text-green-800 flex-shrink-0" title="View audit report" onclick="event.stopPropagation()">
                          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                          </svg>
                          <span class="text-xs ml-0.5">Audit</span>
                        </a>
                      )}
                    </div>
                    <p class="text-xs text-gray-400 truncate">{page.url}</p>
                  </div>
                </div>
                <div class="flex items-center gap-6 flex-shrink-0">
                  <div class="text-right hidden sm:block">
                    <p class="text-sm font-medium text-gray-900">{page.clicks}</p>
                    <p class="text-xs text-gray-400">clicks</p>
                  </div>
                  <div class="text-right hidden sm:block">
                    <p class="text-sm text-gray-600">{page.impressions.toLocaleString()}</p>
                    <p class="text-xs text-gray-400">impr</p>
                  </div>
                  <div class="text-right hidden md:block">
                    <p class="text-sm text-gray-600">{page.ctr}%</p>
                    <p class="text-xs text-gray-400">CTR</p>
                  </div>
                  <div class="flex items-center gap-1 text-gray-400">
                    <span class="text-xs">{page.queries.length} kw</span>
                    <svg class="w-4 h-4 toggle-arrow transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                  </div>
                </div>
              </div>
            </button>

            {/* Expanded keyword detail */}
            <div id={`page-${page.index}`} class="hidden border-t border-gray-100 bg-gray-50">
              <div class="px-6 py-4">
                {/* Mobile metrics (hidden on desktop where they show in header) */}
                <div class="grid grid-cols-3 gap-3 mb-4 sm:hidden">
                  <div class="bg-white rounded p-2 text-center">
                    <p class="text-sm font-medium text-gray-900">{page.clicks}</p>
                    <p class="text-xs text-gray-400">clicks</p>
                  </div>
                  <div class="bg-white rounded p-2 text-center">
                    <p class="text-sm text-gray-600">{page.impressions.toLocaleString()}</p>
                    <p class="text-xs text-gray-400">impr</p>
                  </div>
                  <div class="bg-white rounded p-2 text-center">
                    <p class="text-sm text-gray-600">{page.ctr}%</p>
                    <p class="text-xs text-gray-400">CTR</p>
                  </div>
                </div>

                {/* Keywords with clicks */}
                {page.clickQueries.length >= 1 && (
                  <div class="mb-4">
                    <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Driving clicks ({page.clickQueries.length})</p>
                    <div class="overflow-x-auto">
                      <table class="w-full text-sm">
                        <thead>
                          <tr class="text-xs text-gray-400 uppercase tracking-wider">
                            <th class="text-left py-1.5 pr-3">Keyword</th>
                            <th class="text-right py-1.5 px-2">Clicks</th>
                            <th class="text-right py-1.5 px-2">Impr</th>
                            <th class="text-right py-1.5 px-2">CTR</th>
                            <th class="text-right py-1.5 pl-2">Pos</th>
                          </tr>
                        </thead>
                        <tbody>
                          {page.clickQueries.map(q => (
                            <tr class="border-t border-gray-200">
                              <td class="py-1.5 pr-3 text-gray-800">{q.query}</td>
                              <td class="py-1.5 px-2 text-right font-medium text-gray-900">{q.clicks}</td>
                              <td class="py-1.5 px-2 text-right text-gray-500">{q.impressions.toLocaleString()}</td>
                              <td class="py-1.5 px-2 text-right text-gray-500">{q.ctr}%</td>
                              <td class="py-1.5 pl-2 text-right">
                                <span class={`text-xs font-medium ${posTextColor(q.position)}`}>
                                  {q.position}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                )}

                {/* Impression-only keywords (5+ impressions, no clicks) */}
                {page.impressionOnlyQueries.length >= 1 && (
                  <div>
                    <button data-toggle={`page-${page.index}-impr`} class="flex items-center gap-1 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 hover:text-gray-600">
                      <span>Impressions only ({page.impressionOnlyQueries.length})</span>
                      <svg class="w-3 h-3 toggle-arrow transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                      </svg>
                    </button>
                    <div id={`page-${page.index}-impr`} class="hidden">
                      <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                          <thead>
                            <tr class="text-xs text-gray-400 uppercase tracking-wider">
                              <th class="text-left py-1.5 pr-3">Keyword</th>
                              <th class="text-right py-1.5 px-2">Impr</th>
                              <th class="text-right py-1.5 pl-2">Pos</th>
                            </tr>
                          </thead>
                          <tbody>
                            {page.impressionOnlyQueries.map(q => (
                              <tr class="border-t border-gray-200">
                                <td class="py-1.5 pr-3 text-gray-600">{q.query}</td>
                                <td class="py-1.5 px-2 text-right text-gray-400">{q.impressions}</td>
                                <td class="py-1.5 pl-2 text-right">
                                  <span class={`text-xs ${posTextColor(q.position)}`}>
                                    {q.position}
                                  </span>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                )}

                {/* No keyword data case */}
                {page.queries.length === 0 && (
                  <p class="text-sm text-gray-400 italic">No individual keyword data available — traffic spread across many anonymized long-tail queries.</p>
                )}

                {page.reportSlug && (
                  <div class="mt-4 pt-3 border-t border-gray-200">
                    <a href={`/cs/pages/${page.reportSlug}/`} class="inline-flex items-center gap-1.5 text-sm font-medium text-blue-600 hover:text-blue-800">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                      </svg>
                      View full audit report
                    </a>
                  </div>
                )}
              </div>
            </div>
          </div>
      ))}
    </div>

    <div class="px-6 py-3 border-t border-gray-200 bg-gray-50">
      <p class="text-xs text-gray-400">All data from Google Search Console &middot; {totalKeywords} total keyword entries across {pages.length} pages &middot; Pages with 3+ clicks or 200+ impressions</p>
    </div>
  </div>
</Layout>
