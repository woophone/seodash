---
import Layout from '../layouts/Layout.astro';
import { clientData } from '../data/compulsionsolutions-data.js';

const { client, overview, pages, siteWideIssues, considerations, actionPlan } = clientData;

const page1Pages = pages.filter(p => p.status === 'page-1' || p.status === 'page-1-edge');
const page2Pages = pages.filter(p => p.status === 'page-2');
---

<Layout title={`${client.name} - SEO Dashboard`}>
  <!-- Client Header -->
  <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
    <div class="flex justify-between items-start">
      <div>
        <h2 class="text-3xl font-bold text-gray-900">{client.name}</h2>
        <p class="text-lg text-gray-600 mt-1">{client.domain}</p>
        <p class="text-sm text-gray-500 mt-2">{client.industry}</p>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-400">{client.dataSource}</p>
        <p class="text-xs text-gray-400 mt-1">Analysis: {client.analysisDate}</p>
      </div>
    </div>
  </div>

  <!-- Key Metrics -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Clicks (28 days)</p>
      <p class="text-2xl font-bold text-gray-900">{overview.totalClicks.toLocaleString()}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Impressions</p>
      <p class="text-2xl font-bold text-gray-900">{overview.totalImpressions.toLocaleString()}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Pages on Page 1</p>
      <p class="text-2xl font-bold text-green-600">{overview.pagesOnPage1}</p>
    </div>
    <div class="bg-white rounded-lg shadow-sm p-5">
      <p class="text-sm text-gray-500">Pages on Page 2</p>
      <p class="text-2xl font-bold text-orange-600">{overview.pagesOnPage2}</p>
      <p class="text-xs text-orange-500 mt-1">Can be moved to page 1</p>
    </div>
  </div>

  <!-- Crash Note -->
  {overview.crashNote && (
    <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-8">
      <div class="flex items-start">
        <svg class="w-5 h-5 text-amber-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-sm text-amber-800">{overview.crashNote}</p>
      </div>
    </div>
  )}

  <!-- ============================================ -->
  <!-- PAGE RANKINGS -->
  <!-- ============================================ -->
  <div class="bg-white rounded-lg shadow-sm mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Your Rankings</h3>
      <p class="text-sm text-gray-600">Pages currently ranking on Google, sorted by traffic</p>
    </div>

    <!-- Page 1 Rankings -->
    <div class="px-6 pt-4 pb-2">
      <h4 class="text-sm font-semibold text-green-700 uppercase tracking-wider flex items-center">
        <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
        Google Page 1 ({page1Pages.length} pages)
      </h4>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100">
            <th class="px-6 py-3 text-left">Page</th>
            <th class="px-4 py-3 text-right">Position</th>
            <th class="px-4 py-3 text-right">Clicks</th>
            <th class="px-4 py-3 text-right">Impressions</th>
            <th class="px-4 py-3 text-right">CTR</th>
            <th class="px-6 py-3 text-left">Note</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-50">
          {page1Pages.map(page => (
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-3">
                <p class="text-sm font-medium text-gray-900">{page.shortName}</p>
                <p class="text-xs text-gray-400 truncate max-w-xs">{page.url}</p>
              </td>
              <td class="px-4 py-3 text-right">
                <span class={`inline-flex items-center px-2 py-0.5 rounded text-xs font-bold ${page.position <= 5 ? 'bg-green-100 text-green-800' : page.status === 'page-1-edge' ? 'bg-amber-100 text-amber-800' : 'bg-blue-100 text-blue-800'}`}>
                  #{page.position.toFixed(1)}
                </span>
              </td>
              <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">{page.clicks}</td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">{page.impressions.toLocaleString()}</td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">{page.ctr}%</td>
              <td class="px-6 py-3 text-xs text-gray-500 max-w-xs">{page.note}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- Page 2 Rankings -->
    <div class="px-6 pt-6 pb-2 border-t border-gray-200">
      <h4 class="text-sm font-semibold text-orange-700 uppercase tracking-wider flex items-center">
        <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
        Google Page 2 — push these to page 1 ({page2Pages.length} pages)
      </h4>
    </div>
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead>
          <tr class="text-xs font-medium text-gray-500 uppercase tracking-wider border-b border-gray-100">
            <th class="px-6 py-3 text-left">Page</th>
            <th class="px-4 py-3 text-right">Position</th>
            <th class="px-4 py-3 text-right">Clicks</th>
            <th class="px-4 py-3 text-right">Impressions</th>
            <th class="px-4 py-3 text-right">CTR</th>
            <th class="px-6 py-3 text-left">Note</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-50">
          {page2Pages.map(page => (
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-3">
                <p class="text-sm font-medium text-gray-900">{page.shortName}</p>
                <p class="text-xs text-gray-400 truncate max-w-xs">{page.url}</p>
              </td>
              <td class="px-4 py-3 text-right">
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-bold bg-orange-100 text-orange-800">
                  #{page.position.toFixed(1)}
                </span>
              </td>
              <td class="px-4 py-3 text-right text-sm font-medium text-gray-900">{page.clicks}</td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">{page.impressions.toLocaleString()}</td>
              <td class="px-4 py-3 text-right text-sm text-gray-600">{page.ctr}%</td>
              <td class="px-6 py-3 text-xs text-gray-500 max-w-xs">{page.note}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    <div class="px-6 py-3 bg-gray-50 border-t border-gray-200 rounded-b-lg">
      <p class="text-xs text-gray-500">All position and traffic data from Google Search Console. Competitor data excluded — this shows only your verified performance.</p>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- SITE-WIDE ISSUES -->
  <!-- ============================================ -->
  <div class="bg-white rounded-lg shadow-sm mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">What's Holding You Back</h3>
      <p class="text-sm text-gray-600">Issues affecting your rankings across all {pages.length} tracked pages</p>
    </div>
    <div class="p-6">
      <!-- Critical YMYL Issues -->
      <div class="mb-6">
        <h4 class="text-sm font-semibold text-red-700 uppercase tracking-wider mb-3 flex items-center">
          <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
          YMYL Trust Signals (Critical)
        </h4>
        <div class="space-y-2">
          {siteWideIssues.critical.map(item => (
            <div class="flex items-start p-3 bg-red-50 border border-red-100 rounded-lg">
              <svg class="w-4 h-4 text-red-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
              </svg>
              <div class="flex-1">
                <p class="text-sm text-red-900">{item.issue}</p>
                <p class="text-xs text-red-600 mt-0.5">Affects: {item.applies}</p>
              </div>
            </div>
          ))}
        </div>
      </div>

      <!-- On-Page Issues -->
      <div>
        <h4 class="text-sm font-semibold text-orange-700 uppercase tracking-wider mb-3 flex items-center">
          <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
          On-Page Issues (Quick Fixes)
        </h4>
        <div class="space-y-2">
          {siteWideIssues.onPage.map(item => (
            <div class="flex items-start p-3 bg-orange-50 border border-orange-100 rounded-lg">
              <svg class="w-4 h-4 text-orange-400 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
              </svg>
              <div class="flex-1">
                <p class="text-sm text-orange-900">{item.issue}</p>
                <p class="text-xs text-orange-600 mt-0.5">Affects: {item.applies}</p>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================ -->
  <!-- CONSIDERATIONS -->
  <!-- ============================================ -->
  {considerations && considerations.length > 0 && (
    <div class="mb-8">
      <div class="px-1 mb-6">
        <h3 class="text-2xl font-semibold text-gray-900">Considerations</h3>
        <p class="text-sm text-gray-600 mt-1">Strategic findings from our analysis</p>
      </div>

      <div class="space-y-4">
        {considerations.map((note, index) => (
          <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
            <!-- Collapsed Header -->
            <button
              data-toggle={`consideration-${index}`}
              class="w-full text-left px-6 py-5 hover:bg-gray-50 transition-colors"
            >
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 flex-1 min-w-0">
                  <span class={`inline-flex items-center px-2.5 py-1 rounded-full text-xs font-bold ${
                    note.severity === 'HIGH' ? 'bg-amber-100 text-amber-800' :
                    note.severity === 'CRITICAL' ? 'bg-red-100 text-red-800' :
                    'bg-blue-100 text-blue-800'
                  }`}>
                    {note.category}
                  </span>
                  <h4 class="text-base font-semibold text-gray-900 truncate">{note.title}</h4>
                </div>
                <div class="flex items-center space-x-2 ml-4">
                  <span class="text-sm text-blue-600 font-medium">Details</span>
                  <svg class="w-5 h-5 text-blue-600 toggle-arrow transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </div>
              </div>
            </button>

            <!-- Expanded Details -->
            <div id={`consideration-${index}`} class="hidden border-t border-gray-200">
              <div class="px-6 py-6 space-y-5">

                <!-- Finding -->
                <div>
                  <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">What We Found</h5>
                  <p class="text-sm text-gray-800 leading-relaxed">{note.finding}</p>
                </div>

                <!-- Source Reference (if book/external) -->
                {note.source && (
                  <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <div class="flex items-start space-x-4">
                      <div class="flex-shrink-0 w-10 h-10 bg-amber-100 rounded-lg flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                      </div>
                      <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold text-gray-900">{note.source.title}</p>
                        <p class="text-sm text-gray-600">{note.source.author} &middot; {note.source.publisher}</p>
                        <div class="flex items-center space-x-4 mt-1 text-sm">
                          <span class="text-amber-700 font-medium">{note.source.rating} stars</span>
                          <span class="text-gray-600">{note.source.reviewCount} reviews</span>
                        </div>
                        <a href={note.source.url} target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:underline mt-1 inline-block">
                          View on {note.source.type} &nearr;
                        </a>
                        {note.additionalSources && note.additionalSources.length > 0 && (
                          <div class="mt-3 pt-3 border-t border-gray-200">
                            <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Also on</p>
                            <div class="flex flex-wrap gap-3">
                              {note.additionalSources.map(src => (
                                <a href={src.url} target="_blank" rel="noopener noreferrer" class="inline-flex items-center space-x-2 text-sm text-blue-600 hover:underline">
                                  <span class="font-medium">{src.type}</span>
                                  <span class="text-gray-500">({src.rating} stars &middot; {src.ratingCount} ratings)</span>
                                </a>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                )}

                <!-- External Platforms (for entity considerations) -->
                {note.platforms && note.platforms.length > 0 && (
                  <div>
                    <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">External Profiles (sameAs targets)</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                      {note.platforms.map(platform => (
                        <a href={platform.url} target="_blank" rel="noopener noreferrer" class="flex items-center justify-between p-3 bg-gray-50 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-colors">
                          <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                              <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                              </svg>
                            </div>
                            <span class="text-sm font-medium text-gray-900">{platform.name}</span>
                          </div>
                          <span class="text-xs text-gray-500">{platform.metric}</span>
                        </a>
                      ))}
                    </div>
                  </div>
                )}

                <!-- Why It Matters -->
                <div>
                  <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-2">Why This Matters for Rankings</h5>
                  <p class="text-sm text-gray-800 leading-relaxed">{note.whyItMatters}</p>
                </div>

                <!-- Competitive Angle -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <h5 class="text-sm font-semibold text-blue-900 mb-2">Competitive Advantage</h5>
                  <p class="text-sm text-blue-800 leading-relaxed">{note.competitiveAngle}</p>
                </div>

                <!-- Action Items -->
                {note.actionItems && note.actionItems.length > 0 && (
                  <div>
                    <h5 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Implementation Steps</h5>
                    <div class="space-y-3">
                      {note.actionItems.map((item, i) => (
                        <div class="flex items-start p-4 bg-green-50 border border-green-200 rounded-lg">
                          <div class="flex-shrink-0 w-6 h-6 bg-green-600 rounded-full flex items-center justify-center mr-3 mt-0.5">
                            <span class="text-xs font-bold text-white">{i + 1}</span>
                          </div>
                          <div>
                            <p class="text-sm font-semibold text-green-900">{item.task}</p>
                            <p class="text-sm text-green-800 mt-1 leading-relaxed">{item.detail}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

              </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )}

  <!-- ============================================ -->
  <!-- ACTION PLAN -->
  <!-- ============================================ -->
  <div class="bg-white rounded-lg shadow-sm">
    <div class="px-6 py-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Action Plan</h3>
      <p class="text-sm text-gray-600">{actionPlan.summary}</p>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {actionPlan.phases.map(phase => (
          <div class={`border rounded-lg p-5 ${phase.priority === 'CRITICAL' ? 'border-red-200 bg-red-50' : 'border-blue-200 bg-blue-50'}`}>
            <div class="flex items-center space-x-3 mb-3">
              <div class={`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold text-white ${phase.priority === 'CRITICAL' ? 'bg-red-500' : 'bg-blue-500'}`}>
                {phase.phase}
              </div>
              <div>
                <h4 class="font-semibold text-gray-900">{phase.name}</h4>
                <p class="text-sm text-gray-500">{phase.timeline}</p>
              </div>
            </div>
            <p class="text-sm text-gray-700 mb-3">{phase.description}</p>
            <div class={`text-sm font-medium ${phase.priority === 'CRITICAL' ? 'text-red-800' : 'text-blue-800'}`}>
              {phase.expectedImpact}
            </div>
          </div>
        ))}
      </div>
    </div>
  </div>
</Layout>
