---
interface Props {
  dimensionId: string;
  name: string;
  tier: number;
  category: string;
  auditStatus: string | null;
  summary: string | null;
  score: number | null;
  pendingCount: number;
  completedCount: number;
  totalItems: number;
  cardDescription: string | null;
}

const {
  dimensionId,
  name,
  tier,
  category,
  auditStatus,
  summary,
  score,
  pendingCount,
  completedCount,
  totalItems,
  cardDescription,
} = Astro.props;

// Determine card state and badge
type BadgeState = {
  label: string;
  style: string;
  showCheckmark?: boolean;
};

function getBadge(): BadgeState {
  if (category === 'placeholder') {
    return {
      label: 'Requires Higher Level Audit',
      style: 'bg-purple-100 text-purple-800',
    };
  }
  if (auditStatus === null) {
    return {
      label: 'Not Audited',
      style: 'bg-gray-100 text-gray-600',
    };
  }
  // audited
  if (totalItems === 0) {
    return {
      label: 'Clean',
      style: 'bg-green-100 text-green-800',
    };
  }
  if (pendingCount > 0 && completedCount === 0) {
    return {
      label: `Action Required (${pendingCount})`,
      style: 'bg-amber-100 text-amber-800',
    };
  }
  if (pendingCount > 0 && completedCount > 0) {
    return {
      label: `In Progress (${completedCount}/${totalItems})`,
      style: 'bg-blue-100 text-blue-800',
    };
  }
  // pendingCount === 0 && totalItems > 0
  return {
    label: 'Complete',
    style: 'bg-green-100 text-green-800',
    showCheckmark: true,
  };
}

const badge = getBadge();

// Score circle color
function scoreCircleColor(s: number): string {
  if (s >= 70) return 'bg-green-100 text-green-700 border-green-300';
  if (s >= 40) return 'bg-amber-100 text-amber-700 border-amber-300';
  return 'bg-red-100 text-red-700 border-red-300';
}

// Is the card interactive (clickable to expand)?
const isClickable = auditStatus === 'audited' || totalItems > 0;

// Description text: use summary if audited, cardDescription otherwise
const displayText = (auditStatus === 'audited' && summary) ? summary
  : cardDescription || null;
---

<div
  class:list={[
    'bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-3 sm:p-4',
    isClickable && 'cursor-pointer',
  ]}
  data-toggle={isClickable ? `audit-detail-${dimensionId}` : undefined}
>
  {/* Top row: score circle + name */}
  <div class="flex items-center gap-2.5 mb-2">
    {score !== null && (
      <div class={`w-8 h-8 rounded-full border flex items-center justify-center flex-shrink-0 ${scoreCircleColor(score)}`}>
        <span class="text-xs font-bold">{score}</span>
      </div>
    )}
    <h3 class="text-sm font-semibold text-gray-900 leading-tight">{name}</h3>
  </div>

  {/* Status badge */}
  <div class="mb-2">
    <span class={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium ${badge.style}`}>
      {badge.showCheckmark && (
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7" />
        </svg>
      )}
      {badge.label}
    </span>
  </div>

  {/* Summary / description text */}
  {displayText && (
    <p class="text-xs text-gray-600 line-clamp-2 mb-2">{displayText}</p>
  )}

  {/* Footer: counts + expand hint */}
  {auditStatus === 'audited' && totalItems > 0 && (
    <div class="flex items-center justify-between">
      <div class="text-xs text-gray-400">
        {pendingCount > 0 && (
          <span>{pendingCount} pending</span>
        )}
        {pendingCount > 0 && completedCount > 0 && (
          <span class="mx-1">&middot;</span>
        )}
        {completedCount > 0 && (
          <span>{completedCount} completed</span>
        )}
      </div>
      <span class="toggle-arrow text-gray-400 text-xs transition-transform">&#9654;</span>
    </div>
  )}

  {/* Expand hint for audited cards with no items (clean) */}
  {auditStatus === 'audited' && totalItems === 0 && (
    <div class="flex items-center justify-end">
      <span class="toggle-arrow text-gray-400 text-xs transition-transform">&#9654;</span>
    </div>
  )}
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
